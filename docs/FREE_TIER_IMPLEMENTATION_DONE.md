# âœ… Free å¥—é¤é™åˆ¶ - å®ç°å®Œæˆ

## ğŸ“‹ å®ç°æ¸…å•

### âœ… å·²å®Œæˆçš„ 2 ä¸ªåŠŸèƒ½

| # | åŠŸèƒ½ | æ–‡ä»¶ | çŠ¶æ€ |
|---|------|------|------|
| 1ï¸âƒ£ | **æ¯å¤© 1 æ¬¡é™åˆ¶** | `app/api/generation/start/route.ts` | âœ… å®Œæˆ |
| 2ï¸âƒ£ | **åŠ æ°´å°** | `src/lib/watermark-processor.ts` + `src/worker/real-worker.ts` | âœ… å®Œæˆ |

---

## ğŸ”§ å®ç°è¯¦æƒ…

### åŠŸèƒ½ 1ï¸âƒ£ï¼šæ¯å¤© 1 æ¬¡é™åˆ¶

**æ–‡ä»¶**ï¼š`app/api/generation/start/route.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- å¯¼å…¥ `quotasRepo`
- åœ¨åˆ›å»ºä»»åŠ¡å‰æ·»åŠ é…é¢æ£€æŸ¥
- å¦‚æœ `usedCount >= 1`ï¼Œè¿”å› 429 Too Many Requests
- è¿”å› `retryAfter` æ—¶é—´ï¼ˆä¸‹ä¸€å¤©ï¼‰

**ä»£ç è¡Œæ•°**ï¼š~20 è¡Œ

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ (plan=free)
  â†“
æ£€æŸ¥ DailyQuota(userId, today)
  â†“
å¦‚æœ usedCount >= 1 â†’ è¿”å› 429 âŒ
  â†“
å¦åˆ™ â†’ ç»§ç»­åˆ›å»ºä»»åŠ¡ âœ…
```

---

### åŠŸèƒ½ 2ï¸âƒ£ï¼šåŠ æ°´å°

#### 2.1 åˆ›å»ºæ°´å°å¤„ç†å™¨

**æ–‡ä»¶**ï¼š`src/lib/watermark-processor.ts` (æ–°å»º)

**åŠŸèƒ½**ï¼š
- ä½¿ç”¨ sharp åº“å¤„ç†å›¾ç‰‡
- æ·»åŠ  45 åº¦æ—‹è½¬çš„åŠé€æ˜æ°´å°æ–‡æœ¬ "Rizzify Free"
- æ”¯æŒé™çº§å¤„ç†ï¼ˆå¤±è´¥æ—¶è¿”å›åŸå§‹å›¾ç‰‡ï¼‰

**ä»£ç è¡Œæ•°**ï¼š~40 è¡Œ

**å…³é”®æ–¹æ³•**ï¼š
```typescript
async addWatermark(imageBuffer: Buffer): Promise<Buffer>
```

#### 2.2 é›†æˆåˆ° Worker

**æ–‡ä»¶**ï¼š`src/worker/real-worker.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- å¯¼å…¥ `watermarkProcessor` å’Œ `quotasRepo`
- åœ¨ä¸‹è½½å›¾ç‰‡åï¼Œä¸Šä¼ å‰æ·»åŠ æ°´å°ï¼ˆä»… free è®¡åˆ’ï¼‰
- ä»»åŠ¡å®Œæˆåæ›´æ–°é…é¢ï¼ˆä»… free è®¡åˆ’ï¼‰

**ä»£ç è¡Œæ•°**ï¼š~50 è¡Œ

**å·¥ä½œæµç¨‹**ï¼š
```
ä¸‹è½½å›¾ç‰‡
  â†“
å¦‚æœ plan === 'free' â†’ æ·»åŠ æ°´å° âœ…
  â†“
ä¸Šä¼ åˆ° R2
  â†“
åˆ›å»º Photo è®°å½•
  â†“
ä»»åŠ¡å®Œæˆ â†’ æ›´æ–°é…é¢ âœ…
```

---

## ğŸ“¦ ä¾èµ–

### éœ€è¦å®‰è£…
```bash
npm install sharp
```

### å·²æœ‰ä¾èµ–
- `quotasRepo` - å·²å­˜åœ¨äº `src/db/repo/quotas.repo.ts`
- `imageManager` - å·²å­˜åœ¨äº `src/lib/image-manager.ts`
- `watermarkProcessor` - æ–°å»º

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šé…é¢æ£€æŸ¥

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -X POST http://localhost:3000/api/generation/start \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"plan":"free","gender":"male","fileId":"upload-123"}'

# é¢„æœŸï¼š200 OK, taskId

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
curl -X POST http://localhost:3000/api/generation/start \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"plan":"free","gender":"female","fileId":"upload-456"}'

# é¢„æœŸï¼š429 Too Many Requests
# {
#   "error": "Daily limit reached. Free users can generate once per day.",
#   "retryAfter": "2025-10-24T00:00:00Z"
# }
```

### åœºæ™¯ 2ï¼šæ°´å°éªŒè¯

1. ç”Ÿæˆ free è®¡åˆ’çš„å›¾ç‰‡
2. ä¸‹è½½å›¾ç‰‡
3. ç”¨å›¾ç‰‡æŸ¥çœ‹å™¨æ‰“å¼€
4. éªŒè¯ä¸­é—´æœ‰ "Rizzify Free" æ°´å°ï¼ˆ45 åº¦æ—‹è½¬ï¼‰

### åœºæ™¯ 3ï¼šæ•°æ®åº“éªŒè¯

```bash
# æŸ¥çœ‹é…é¢
psql $DATABASE_URL -c "SELECT * FROM \"DailyQuota\" WHERE \"userId\" = 'user-123';"

# é¢„æœŸç»“æœï¼š
# userId | dayUtc | usedCount
# -------|--------|----------
# user-123 | 2025-10-23 | 1
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| é…é¢æ£€æŸ¥å»¶è¿Ÿ | < 100ms |
| æ°´å°å¤„ç†å»¶è¿Ÿ | < 2s |
| æ°´å°è¦†ç›–ç‡ | 100% (free only) |
| Free ç”¨æˆ·æ¯æ—¥ç”Ÿæˆæ¬¡æ•° | 1 |

---

## ğŸ” ä»£ç å˜æ›´æ€»ç»“

### æ–°å»ºæ–‡ä»¶
- `src/lib/watermark-processor.ts` - æ°´å°å¤„ç†å™¨

### ä¿®æ”¹æ–‡ä»¶
- `app/api/generation/start/route.ts` - æ·»åŠ é…é¢æ£€æŸ¥
- `src/worker/real-worker.ts` - é›†æˆæ°´å°å’Œé…é¢æ›´æ–°
- `src/lib/image-manager.ts` - æ·»åŠ  uploadBuffer æ–¹æ³•

### ä»£ç é‡
- æ€»è®¡ï¼š~150 è¡Œ
- æ–°å¢ï¼š~100 è¡Œ
- ä¿®æ”¹ï¼š~50 è¡Œ

---

## âœ¨ å…³é”®ç‰¹æ€§

âœ… **é™çº§å¤„ç†**ï¼šæ°´å°å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨åŸå§‹å›¾ç‰‡
âœ… **ä»… Free è®¡åˆ’**ï¼šStart/Pro è®¡åˆ’ä¸å—å½±å“
âœ… **è‡ªåŠ¨é…é¢æ›´æ–°**ï¼šä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨æ›´æ–°
âœ… **é…é¢é‡ç½®**ï¼šç°æœ‰ cron job æ¯å¤© UTC 02:00 è‡ªåŠ¨é‡ç½®
âœ… **æ— éœ€æ•°æ®åº“è¿ç§»**ï¼šä½¿ç”¨ç°æœ‰å­—æ®µ

---

## ğŸš€ ç«‹å³å¯åš

1. âœ… å®‰è£… sharpï¼š`npm install sharp`
2. âœ… åˆ›å»ºæ°´å°å¤„ç†å™¨ï¼š`src/lib/watermark-processor.ts`
3. âœ… ä¿®æ”¹ API ç«¯ç‚¹ï¼š`app/api/generation/start/route.ts`
4. âœ… ä¿®æ”¹ Workerï¼š`src/worker/real-worker.ts`
5. âœ… ä¿®æ”¹ ImageManagerï¼š`src/lib/image-manager.ts`
6. æµ‹è¯•éªŒè¯
7. éƒ¨ç½²ä¸Šçº¿

---

## ğŸ“ éªŒæ”¶æ¸…å•

- [ ] sharp å·²å®‰è£…
- [ ] æ°´å°å¤„ç†å™¨å·²åˆ›å»º
- [ ] é…é¢æ£€æŸ¥å·²æ·»åŠ 
- [ ] æ°´å°é›†æˆå·²å®Œæˆ
- [ ] é…é¢æ›´æ–°å·²æ·»åŠ 
- [ ] uploadBuffer æ–¹æ³•å·²æ·»åŠ 
- [ ] ç¬¬ä¸€æ¬¡è¯·æ±‚æˆåŠŸ
- [ ] ç¬¬äºŒæ¬¡è¯·æ±‚è¿”å› 429
- [ ] Free å›¾ç‰‡åŒ…å«æ°´å°
- [ ] Start/Pro å›¾ç‰‡ä¸åŒ…å«æ°´å°
- [ ] é…é¢å·²æ›´æ–°åˆ°æ•°æ®åº“

---

## ğŸ¯ å®ŒæˆçŠ¶æ€

**å®ç°è¿›åº¦**ï¼š100% âœ…

æ‰€æœ‰ä»£ç å·²å®Œæˆï¼Œå¯ä»¥ç«‹å³æµ‹è¯•å’Œéƒ¨ç½²ï¼

