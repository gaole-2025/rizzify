# Free 套餐限制方案 - 总结

## 🎯 需求回顾

```
✅ 每个用户每天只能生成 1 次（2 张图片）
✅ 所有 Free 生成的图片都要加水印
✅ 24 小时后自动过期
✅ 过期图片自动从 R2 删除
```

---

## 🏗️ 架构方案

### 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户请求                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │  API: /api/generation/start        │
        │  ✅ 配额检查 (DailyQuota)          │
        │  - 检查 usedCount < 1              │
        │  - 返回 429 如果超限               │
        └────────────────┬───────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │  创建 Task 记录                     │
        │  - plan = "free"                   │
        │  - 入队到 pg-boss                  │
        └────────────────┬───────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │  Worker: real-worker.ts            │
        │  1. 美颜处理                       │
        │  2. 生成 2 张图片                  │
        │  3. 添加水印 (watermark-processor) │
        │  4. 上传到 R2                      │
        │  5. 创建 Photo 记录                │
        │     - expiresAt = now + 24h        │
        │  6. 更新 DailyQuota                │
        │     - usedCount += 1               │
        └────────────────┬───────────────────┘
                         │
        ┌────────────────┴───────────────────┐
        │                                    │
        ▼                                    ▼
   ┌──────────────┐              ┌──────────────────────┐
   │  R2 存储     │              │  数据库               │
   │  - 原始图片  │              │  - Photo (expiresAt) │
   │  - 水印图片  │              │  - DailyQuota        │
   └──────────────┘              └──────────────────────┘
        │                                    │
        │                                    │
        └────────────────┬───────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │  Cron Job 1: 每小时第 5 分钟       │
        │  cleanup-expired-photos.ts         │
        │  - 查询 expiresAt < now 的 Photo  │
        │  - 从 R2 删除文件                  │
        │  - 标记 deletedAt                  │
        └────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────┐
        │  Cron Job 2: 每天 UTC 02:00        │
        │  quotas-rollover.ts                │
        │  - 初始化新的 DailyQuota           │
        │  - 重置 usedCount = 0              │
        └────────────────────────────────────┘
```

---

## 📋 实现清单

### Phase 1️⃣：配额检查 ✅
**文件**：`app/api/generation/start/route.ts`
- 在创建任务前检查 DailyQuota
- 如果 usedCount >= 1，返回 429
- 返回 retryAfter 时间

**代码量**：~20 行

---

### Phase 2️⃣：水印处理 ✅
**文件**：`src/lib/watermark-processor.ts` (新建)
- 使用 sharp 库添加水印
- 支持自定义水印文本
- 降级处理（失败时使用原始图片）

**文件**：`src/worker/real-worker.ts` (修改)
- 在上传前添加水印
- 仅 free 计划添加

**代码量**：~80 行

---

### Phase 3️⃣：过期时间和配额更新 ✅
**文件**：`src/worker/real-worker.ts` (修改)
- 设置 Photo.expiresAt = now + 24h
- 更新 DailyQuota.usedCount

**代码量**：~15 行

---

### Phase 4️⃣：自动清理 ✅
**文件**：`scripts/cleanup-expired-photos.ts` (新建)
- 查询过期的 Photo
- 从 R2 删除文件
- 标记 deletedAt

**文件**：`src/lib/cron-jobs.ts` (新建)
- 注册 Cron 任务
- 每小时第 5 分钟运行清理
- 每天 UTC 02:00 运行配额重置

**代码量**：~100 行

---

## 💾 数据库

### 现有表结构（无需迁移）

```prisma
model DailyQuota {
  userId    String
  dayUtc    DateTime @db.Date
  usedCount Int      @default(0)
  @@id([userId, dayUtc])
}

model Photo {
  id        String    @id
  taskId    String
  section   Section   // "free" | "start" | "pro"
  objectKey String
  expiresAt DateTime? // ✅ 已有
  deletedAt DateTime? // ✅ 已有
  // ...
}
```

**结论**：✅ 无需数据库迁移，现有结构完全支持

---

## 🔄 完整流程

### 用户视角

```
Day 1 - 10:00
├─ 用户上传图片
├─ 选择 Free 计划
└─ 提交生成请求

Day 1 - 10:05
├─ 系统检查配额 ✅ 通过
├─ 生成 2 张图片
├─ 添加水印
└─ 返回结果

Day 1 - 10:10
├─ 用户尝试再次生成
├─ 系统检查配额 ❌ 超限
└─ 返回 "明天 02:00 可以重新生成"

Day 2 - 02:00
├─ Cron: 配额重置
├─ 用户配额恢复为 0
└─ 历史数据保留

Day 2 - 10:05
├─ Cron: 清理过期图片
├─ Day 1 的图片已删除
└─ 数据库标记 deletedAt

Day 2 - 10:10
├─ 用户再次生成 ✅ 可以
└─ 新的配额周期开始
```

---

## 📊 关键指标

| 指标 | 值 | 说明 |
|------|-----|------|
| 每日生成次数 | 1 | Free 用户每天 1 次 |
| 生成图片数 | 2 | 每次生成 2 张 |
| 过期时间 | 24h | 24 小时后过期 |
| 清理频率 | 每小时 | 第 5 分钟运行 |
| 配额重置 | 每天 UTC 02:00 | 全球统一时间 |
| 水印覆盖率 | 100% | 所有 Free 图片 |

---

## 🧪 测试场景

### 场景 1：正常生成
```
1. 用户 A 提交 free 请求
2. ✅ 配额检查通过
3. ✅ 生成 2 张图片 + 水印
4. ✅ 设置 expiresAt = now + 24h
5. ✅ 更新 usedCount = 1
```

### 场景 2：超过限制
```
1. 用户 A 再次提交 free 请求（同一天）
2. ❌ 配额检查失败 (usedCount >= 1)
3. ❌ 返回 429 Too Many Requests
4. ❌ 返回 retryAfter 时间
```

### 场景 3：配额重置
```
1. Day 1 23:59：用户 A 的 usedCount = 1
2. Day 2 02:00：Cron 运行，初始化新的 DailyQuota
3. Day 2 02:05：用户 A 的 usedCount = 0（新周期）
4. Day 2 10:00：用户 A 可以再次生成
```

### 场景 4：过期清理
```
1. Day 1 10:05：Photo 创建，expiresAt = Day 2 10:05
2. Day 2 10:05：Cron 运行，查询过期 Photo
3. Day 2 10:05：从 R2 删除文件
4. Day 2 10:05：标记 deletedAt
5. Day 2 10:10：用户查询时，已删除的图片不显示
```

---

## 🚀 部署步骤

### 第 1 步：代码实现（4-5 小时）
- [ ] 实现配额检查
- [ ] 实现水印处理
- [ ] 实现过期时间设置
- [ ] 实现自动清理

### 第 2 步：测试（2-3 小时）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 手动测试

### 第 3 步：部署（1 小时）
- [ ] 代码审查
- [ ] 部署到生产
- [ ] 监控告警

### 第 4 步：验证（1 小时）
- [ ] 功能验证
- [ ] 性能监控
- [ ] 日志检查

---

## 📈 预期效果

### 用户体验
- ✅ Free 用户明确了解每日限制
- ✅ 水印标识了 Free 图片
- ✅ 自动清理节省存储空间
- ✅ 配额重置时间固定（UTC 02:00）

### 商业价值
- ✅ 鼓励用户升级到 Start/Pro
- ✅ 减少存储成本
- ✅ 防止滥用
- ✅ 提高用户粘性

### 技术指标
- ✅ 配额检查延迟 < 100ms
- ✅ 水印处理延迟 < 2s
- ✅ 清理成功率 > 99%
- ✅ 系统可用性 > 99.9%

---

## 💡 未来优化

### 短期（1-2 周）
1. **灵活配额**：支持不同用户不同的每日限制
2. **配额购买**：允许用户购买额外配额
3. **分析仪表板**：展示 Free 用户的使用统计

### 中期（1-2 月）
1. **水印定制**：支持自定义水印文本
2. **批量清理**：优化清理性能
3. **配额转移**：允许用户在月末转移未使用的配额

### 长期（3-6 月）
1. **AI 定价**：根据使用情况动态调整配额
2. **社交分享**：分享图片获得额外配额
3. **推荐奖励**：邀请朋友获得额外配额

---

## 📞 支持

### 常见问题

**Q: Free 用户可以生成多少张图片？**
A: 每天 1 次，每次 2 张，共 2 张/天

**Q: 图片什么时候过期？**
A: 24 小时后自动过期并删除

**Q: 配额什么时候重置？**
A: 每天 UTC 02:00 重置

**Q: 可以购买额外配额吗？**
A: 暂不支持，建议升级到 Start/Pro 计划

**Q: 水印可以去掉吗？**
A: 不可以，水印是 Free 计划的标识

---

## 📝 文档链接

- [详细设计方案](./FREE_TIER_DESIGN.md)
- [快速实现清单](./FREE_TIER_IMPLEMENTATION.md)
- [API 文档](./API.md)
- [数据库 Schema](../prisma/schema.prisma)

---

## ✅ 完成状态

- [x] 需求分析
- [x] 架构设计
- [x] 实现方案
- [x] 测试计划
- [ ] 代码实现（待开始）
- [ ] 测试验证（待开始）
- [ ] 生产部署（待开始）

