# Worker 并发能力分析报告

## 📊 当前架构概览

### Worker 配置
```typescript
const WORKER_CONFIG = {
  name: 'task_generate',
  teamSize: 4,              // 4 个并行 worker 线程
  newJobCheckIntervalSeconds: 5,
};
```

### 并发层级

| 层级 | 并发度 | 说明 |
|------|--------|------|
| **Worker 线程** | 4 | pg-boss teamSize = 4 |
| **API 请求** | 3 | Apicore API 并发度 = 3 |
| **下载/上传** | 5 | R2 下载/上传并发度 = 5 |

---

## 🚀 性能计算

### 单个任务耗时（Pro 计划 70张图片）

#### 时间分解

| 阶段 | 耗时 | 说明 |
|------|------|------|
| 美颜处理 | ~8 秒 | 1 次 API 调用 |
| **API 生成** | ~112 秒 | 70张 ÷ 5张/batch × 8秒/batch × 3并发 = 112秒 |
| **下载/上传** | ~28 秒 | 70张 ÷ 5并发 × 2秒/张 = 28秒 |
| 数据库操作 | ~5 秒 | 批量创建（1 次查询） |
| 其他开销 | ~10 秒 | 网络、日志等 |
| **总计** | **~163 秒** | **≈ 2.7 分钟** |

#### 各计划耗时预估

| 计划 | 图片数 | API 耗时 | 下载/上传 | 总耗时 |
|------|--------|---------|---------|--------|
| **Free** | 2 | ~16 秒 | ~4 秒 | **~30 秒** |
| **Start** | 30 | ~48 秒 | ~12 秒 | **~75 秒** |
| **Pro** | 70 | ~112 秒 | ~28 秒 | **~163 秒** |

---

## 👥 并发用户支持能力

### 场景 1：同时上线 10 个用户

**假设**：
- 10 个用户同时提交任务
- 都选择 Pro 计划（最坏情况）
- 每个任务耗时 163 秒

**计算**：
```
Worker 队列处理：
- 4 个 worker 并行处理
- 每个 worker 处理 1 个任务 = 163 秒
- 第 1-4 个任务：同时开始，163 秒完成
- 第 5-8 个任务：163 秒后开始，326 秒完成
- 第 9-10 个任务：326 秒后开始，489 秒完成

总耗时：489 秒 ≈ 8.15 分钟
平均等待时间：(0 + 163 + 163 + 163 + 326 + 326 + 326 + 489 + 489 + 489) / 10 = 3.4 分钟
```

### 场景 2：每分钟 5 个用户提交

**假设**：
- 每分钟 5 个用户提交任务
- 都选择 Pro 计划
- 持续 1 小时

**计算**：
```
每分钟任务数：5
每分钟完成数：4 worker × 60秒 / 163秒 ≈ 1.5 个任务

任务堆积：
- 分钟 1：5 个任务入队，1.5 个完成，剩余 3.5
- 分钟 2：5 个新任务 + 3.5 剩余 = 8.5，1.5 个完成，剩余 7
- 分钟 3：5 个新任务 + 7 剩余 = 12，1.5 个完成，剩余 10.5
- ...
- 最终稳定在：5 个新任务 - 1.5 个完成 = 3.5 个任务/分钟堆积

最坏情况：
- 队列深度：3.5 × 60 = 210 个任务
- 最后一个用户等待时间：210 × 163 秒 ≈ 9.3 小时 ❌ 不可接受
```

### 场景 3：高峰期 20 个用户（分布式场景）

**假设**：
- 20 个用户同时在线
- 平均每 30 秒提交 1 个任务
- 混合计划（Free 30%、Start 40%、Pro 30%）

**平均任务耗时**：
```
0.3 × 30 + 0.4 × 75 + 0.3 × 163 = 9 + 30 + 48.9 = 87.9 秒 ≈ 88 秒
```

**吞吐量**：
```
4 worker × 60秒 / 88秒 ≈ 2.7 个任务/分钟
```

**任务提交速率**：
```
20 个用户 × 1 个任务/30秒 = 2.7 个任务/分钟
```

**结果**：
```
提交速率 ≈ 完成速率 → 队列稳定，无堆积 ✅
平均等待时间：(4 worker × 88秒) / 2 ≈ 176 秒 ≈ 3 分钟
```

---

## 🔴 当前瓶颈

### 1. **Worker 线程数限制** (最严重)
- **当前**: 4 个 worker
- **问题**: 单个任务耗时长（163 秒），导致吞吐量低
- **影响**: 任务队列容易堆积

### 2. **API 调用速度** (次严重)
- **当前**: 每张图片 8 秒（Apicore API）
- **问题**: 无法加速（API 限制）
- **影响**: Pro 计划需要 112 秒仅用于 API 调用

### 3. **数据库连接池**
- **当前**: 默认 Prisma 连接池
- **问题**: 4 个 worker × 多个并发操作 = 可能耗尽连接
- **影响**: 数据库连接等待

### 4. **R2 存储限制**
- **当前**: 无限制（Cloudflare R2）
- **问题**: 并发上传可能受限
- **影响**: 下载/上传阶段可能被限流

---

## ✅ 优化建议

### 优先级 1：立即实施（低成本）

#### 1.1 增加 Worker 线程数
```typescript
const WORKER_CONFIG = {
  teamSize: 8,  // 从 4 → 8
};
```

**效果**：
- 吞吐量提升 2 倍
- 每分钟完成任务数：1.5 → 3 个
- 成本：内存 +200MB，数据库连接 +4

#### 1.2 优化数据库连接池
```typescript
const prisma = new PrismaClient({
  datasources: {
    db: {
      url: `${DATABASE_URL}?connection_limit=20&pool_timeout=10`
    }
  }
});
```

**效果**：
- 避免连接耗尽
- 成本：无额外成本

#### 1.3 增加 API 并发度
```typescript
const concurrency = 5;  // 从 3 → 5
```

**效果**：
- API 阶段：112 秒 → 70 秒
- 总耗时：163 秒 → 121 秒（提升 26%）
- 成本：API 限流风险

### 优先级 2：中期优化（中等成本）

#### 2.1 添加任务优先级队列
```typescript
// 优先处理 Free 和 Start 计划
// 降低 Pro 计划优先级
```

**效果**：
- 用户感知更好（快速计划先完成）
- 成本：代码改动

#### 2.2 实现任务预热
```typescript
// 在空闲时预生成美颜版本
// 减少任务处理时间
```

**效果**：
- 单个任务耗时：163 秒 → 155 秒（减少 8 秒）
- 成本：额外存储和计算

#### 2.3 添加缓存层
```typescript
// 缓存相同提示词的结果
// 减少重复 API 调用
```

**效果**：
- 重复用户：耗时减少 30-50%
- 成本：Redis 缓存

### 优先级 3：长期优化（高成本）

#### 3.1 分布式 Worker
```typescript
// 在多个服务器上运行 Worker
// 每个服务器 4-8 个 worker
```

**效果**：
- 吞吐量线性提升
- 成本：基础设施成本

#### 3.2 异步处理分离
```typescript
// 将下载/上传分离到独立的 Worker
// 并行处理多个任务阶段
```

**效果**：
- 总耗时：163 秒 → 100 秒（提升 39%）
- 成本：架构复杂度提升

---

## 📈 上线建议

### 初期（用户 < 100）
✅ **当前配置可支持**
- Worker: 4 个
- 预期并发：2-3 个用户/分钟
- 平均等待时间：3-5 分钟

### 中期（用户 100-1000）
⚠️ **需要优化**
- 实施优先级 1 的所有优化
- Worker: 8 个
- 预期并发：4-6 个用户/分钟
- 平均等待时间：2-3 分钟

### 后期（用户 > 1000）
🔴 **需要重构**
- 实施优先级 2 的优化
- 考虑分布式 Worker
- 预期并发：10+ 个用户/分钟
- 平均等待时间：< 2 分钟

---

## 🎯 立即行动项

### 第 1 步：增加 Worker 线程（5 分钟）
```typescript
// src/worker/real-worker.ts
const WORKER_CONFIG = {
  teamSize: 8,  // ← 改这里
};
```

### 第 2 步：优化数据库连接（10 分钟）
```typescript
// .env
DATABASE_URL="postgresql://...?connection_limit=20&pool_timeout=10"
```

### 第 3 步：监控任务队列（20 分钟）
```typescript
// 添加队列深度监控
// 添加任务耗时统计
// 添加告警规则
```

### 第 4 步：压力测试（1 小时）
```bash
# 模拟 10 个并发用户
# 验证系统稳定性
# 收集性能数据
```

---

## 📊 总结表

| 指标 | 当前 | 优化后 | 目标 |
|------|------|--------|------|
| Worker 线程 | 4 | 8 | 16+ |
| 单任务耗时 (Pro) | 163s | 121s | < 60s |
| 吞吐量 (任务/分钟) | 1.5 | 3 | 10+ |
| 平均等待时间 | 3-5分钟 | 2-3分钟 | < 1分钟 |
| 支持并发用户 | 2-3 | 4-6 | 10+ |

